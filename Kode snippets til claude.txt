Vpilothomekitconnector.sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.0.31903.59
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "VPilotHomekitConnector", "VPilotHomekitConnector\VPilotHomekitConnector.csproj", "{64B006D8-0F08-4C45-83A5-C3F25AD03C87}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{64B006D8-0F08-4C45-83A5-C3F25AD03C87}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{64B006D8-0F08-4C45-83A5-C3F25AD03C87}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{64B006D8-0F08-4C45-83A5-C3F25AD03C87}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{64B006D8-0F08-4C45-83A5-C3F25AD03C87}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
EndGlobal

// AssemblyInfo.cs
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;

[assembly: AssemblyTitle("VPilot HomeKit Connector")]
[assembly: AssemblyDescription("HomeKit integration for vPilot messages")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("Montislignum")]
[assembly: AssemblyProduct("VPilot HomeKit Connector")]
[assembly: AssemblyCopyright("Copyright Â© 2024")]
[assembly: AssemblyTrademark("")]
[assembly: AssemblyCulture("")]

[assembly: ComVisible(false)]
[assembly: Guid("64B006D8-0F08-4C45-83A5-C3F25AD03C87")]

[assembly: AssemblyVersion("1.0.0.0")]
[assembly: AssemblyFileVersion("1.0.0.0")]

homekitplugin.cs


using System;
using System.IO;
using System.Net.Sockets;
using System.Text;
using Microsoft.Win32;
using RossCarlson.Vatsim.Vpilot.Plugins;
using RossCarlson.Vatsim.Vpilot.Plugins.Events;

namespace VPilotHomekitConnector
{
    public class HomekitPlugin : IPlugin
    {
        private const string PLUGIN_NAME = "HomeKit Connector";
        private const int PORT = 3000;

        private IBroker vPilot;
        private string configPath;
        private bool settingsLoaded = false;
        private string raspberryPiIp = "192.168.1.100";
        private string connectedCallsign = null;

        public string Name { get; } = PLUGIN_NAME;

        public void Initialize(IBroker broker)
        {
            vPilot = broker;
            LoadSettings();

            if (settingsLoaded)
            {
                vPilot.NetworkConnected += OnNetworkConnectedHandler;
                vPilot.NetworkDisconnected += OnNetworkDisconnectedHandler;
                vPilot.RadioMessageReceived += OnRadioMessageReceivedHandler;
                vPilot.PrivateMessageReceived += OnPrivateMessageReceivedHandler;

                SendDebug($"HomeKit Connector initialized. Using Raspberry Pi at {raspberryPiIp}");
            }
            else
            {
                SendDebug("HomeKit Connector failed to load. Check your homekit_config.ini");
            }
        }

        private void LoadSettings()
        {
            RegistryKey registryKey = Registry.CurrentUser.OpenSubKey("Software\\vPilot");
            if (registryKey != null)
            {
                string vPilotPath = (string)registryKey.GetValue("Install_Dir");
                configPath = Path.Combine(vPilotPath, "Plugins", "homekit_config.ini");

                if (!File.Exists(configPath))
                {
                    CreateDefaultConfig();
                }

                try
                {
                    string[] lines = File.ReadAllLines(configPath);
                    foreach (string line in lines)
                    {
                        if (line.StartsWith("RaspberryPiIP="))
                        {
                            raspberryPiIp = line.Substring("RaspberryPiIP=".Length).Trim();
                        }
                    }
                    settingsLoaded = true;
                }
                catch (Exception ex)
                {
                    SendDebug($"Error loading config: {ex.Message}");
                }
            }
            else
            {
                SendDebug("Registry key not found. Is vPilot installed correctly?");
            }
        }

        private void CreateDefaultConfig()
        {
            try
            {
                string defaultConfig = @"; HomeKit Connector Configuration
; Edit this file to set your Raspberry Pi's IP address
RaspberryPiIP=192.168.1.100";

                Directory.CreateDirectory(Path.GetDirectoryName(configPath));
                File.WriteAllText(configPath, defaultConfig);
                SendDebug($"Created default config file at {configPath}");
            }
            catch (Exception ex)
            {
                SendDebug($"Error creating default config: {ex.Message}");
            }
        }

        private void OnNetworkConnectedHandler(object sender, NetworkConnectedEventArgs e)
        {
            connectedCallsign = e.Callsign;
            SendDebug($"Connected with callsign: {connectedCallsign}");
        }

        private void OnNetworkDisconnectedHandler(object sender, EventArgs e)
        {
            connectedCallsign = null;
            SendDebug("Disconnected from network");
        }

        private void OnRadioMessageReceivedHandler(object sender, RadioMessageReceivedEventArgs e)
        {
            if (e.Message.Contains(connectedCallsign))
            {
                NotifyHomebridge("NEW_MESSAGE");
            }
        }

        private void OnPrivateMessageReceivedHandler(object sender, PrivateMessageReceivedEventArgs e)
        {
            NotifyHomebridge("NEW_PRIVATE_MESSAGE");
        }

        private void NotifyHomebridge(string messageType)
        {
            try
            {
                using (TcpClient client = new TcpClient())
                {
                    client.Connect(raspberryPiIp, PORT);
                    using (NetworkStream stream = client.GetStream())
                    {
                        byte[] data = Encoding.UTF8.GetBytes(messageType);
                        stream.Write(data, 0, data.Length);
                    }
                }
                SendDebug($"Notified Homebridge: {messageType}");
            }
            catch (Exception ex)
            {
                SendDebug($"Error notifying Homebridge: {ex.Message} (IP: {raspberryPiIp})");
            }
        }

        private void SendDebug(string text)
        {
            vPilot.PostDebugMessage(text);
        }

        public void Configure()
        {
            try
            {
                System.Diagnostics.Process.Start("notepad.exe", configPath);
            }
            catch (Exception ex)
            {
                SendDebug($"Error opening config file: {ex.Message}");
            }
        }

        public void Shutdown()
        {
            SendDebug("HomeKit Connector shutting down");
        }
    }
}

Vpilothomekitconnector.csproj
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFrameworks>net35;net472</TargetFrameworks>
    <UseWindowsForms>true</UseWindowsForms>
    <OutputType>Library</OutputType>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <AssemblyName>VPilotHomekitConnector</AssemblyName>
  </PropertyGroup>

  <PropertyGroup Condition="'$(TargetFramework)' == 'net472'">
    <OutputPath>bin\$(Configuration)\net472</OutputPath>
  </PropertyGroup>

  <PropertyGroup Condition="'$(TargetFramework)' == 'net35'">
    <OutputPath>bin\$(Configuration)\net35</OutputPath>
  </PropertyGroup>

  <ItemGroup>
    <Reference Include="RossCarlson.Vatsim.Vpilot.Plugins">
      <HintPath>..\Dependencies\RossCarlson.Vatsim.Vpilot.Plugins.dll</HintPath>
    </Reference>
    <Reference Include="System.Windows.Forms" />
    <Reference Include="System" />
    <Reference Include="System.Core" />
    <Reference Include="System.Data" />
    <Reference Include="System.Drawing" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="Properties\Settings.Designer.cs">
      <DesignTimeSharedInput>True</DesignTimeSharedInput>
      <AutoGen>True</AutoGen>
      <DependentUpon>Settings.settings</DependentUpon>
    </Compile>
  </ItemGroup>

  <ItemGroup>
    <None Update="Properties\Settings.settings">08:53 02-01-2025
      <Generator>SettingsSingleFileGenerator</Generator>
      <LastGenOutput>Settings.Designer.cs</LastGenOutput>
    </None>
  </ItemGroup>

  <Target Name="PostBuild" AfterTargets="PostBuildEvent">
    <PropertyGroup>
      <PluginDir>$(LocalAppData)\vPilot\Plugins</PluginDir>
    </PropertyGroup>

    <Message Text="Ensuring Plugin directory exists..." Importance="high" />
    <MakeDir Directories="$(PluginDir)" Condition="!Exists('$(PluginDir)')" />

    <Message Text="Copying $(TargetPath) to $(PluginDir)" Importance="high" />
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(PluginDir)" />
  </Target>

</Project>

